# Daily cleanup job to scale old review apps to 0
name: Fly Review App Cleanup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  cleanup-old-review-apps:
    name: Scale old review apps to 0
    runs-on: ubuntu-latest
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Cleanup old review apps
        run: |
          echo "Checking for review apps older than 1 week..."
          
          # Get current timestamp
          CURRENT_TIME=$(date +%s)
          ONE_WEEK_AGO=$((CURRENT_TIME - 604800)) # 604800 seconds = 7 days
          
          # List all apps and filter for review apps
          APPS=$(flyctl apps list --json)
          
          echo "$APPS" | jq -r '.[] | select(.Name | startswith("go-sushi-pr-")) | .Name' | while read -r APP_NAME; do
            if [ -z "$APP_NAME" ]; then
              continue
            fi
            
            echo "Checking app: $APP_NAME"
            
            # Get app info to check creation date
            APP_INFO=$(flyctl apps list --json | jq -r ".[] | select(.Name == \"$APP_NAME\")")
            
            # Get the app status
            APP_STATUS=$(flyctl status --app "$APP_NAME" --json 2>/dev/null || echo "{}")
            
            # Extract creation date from app info
            # Fly.io apps don't expose creation date directly via CLI, so we'll use a different approach:
            # Check the app's last deployment or activity date
            
            # For now, we'll check if the app exists and scale based on machine status
            # We'll use a tag/label approach or check deployment history
            
            # Get app releases to find the first deployment
            RELEASES=$(flyctl releases --app "$APP_NAME" --json 2>/dev/null || echo "[]")
            
            if [ "$RELEASES" != "[]" ] && [ -n "$RELEASES" ]; then
              # Get the oldest release (first deployment)
              OLDEST_RELEASE=$(echo "$RELEASES" | jq -r '.[-1].CreatedAt' 2>/dev/null || echo "")
              
              if [ -n "$OLDEST_RELEASE" ] && [ "$OLDEST_RELEASE" != "null" ]; then
                # Parse the creation timestamp
                RELEASE_TIME=$(date -d "$OLDEST_RELEASE" +%s 2>/dev/null || echo "0")
                
                if [ "$RELEASE_TIME" -gt 0 ] && [ "$RELEASE_TIME" -lt "$ONE_WEEK_AGO" ]; then
                  echo "App $APP_NAME is older than 1 week (created: $OLDEST_RELEASE)"
                  echo "Scaling app to 0 machines..."
                  
                  # Scale the app to 0
                  flyctl scale count 0 --app "$APP_NAME" --yes || echo "Failed to scale $APP_NAME"
                  
                  echo "âœ… Scaled $APP_NAME to 0"
                else
                  echo "App $APP_NAME is less than 1 week old, skipping..."
                fi
              else
                echo "Could not determine creation date for $APP_NAME, skipping..."
              fi
            else
              echo "No releases found for $APP_NAME, skipping..."
            fi
          done
          
          echo "Cleanup complete!"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Summary
        run: |
          echo "Review app cleanup job completed."
          echo "Any review apps older than 1 week have been scaled to 0."
