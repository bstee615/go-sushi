# Daily cleanup job to scale old review apps to 0
name: Fly Review App Cleanup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger for testing

# Minimal permissions for security - no GitHub API access needed
permissions: {}

jobs:
  cleanup-old-review-apps:
    name: Scale old review apps to 0
    runs-on: ubuntu-latest
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Cleanup old review apps
        run: |
          echo "Checking for review apps older than 1 week..."
          
          # Get current timestamp
          CURRENT_TIME=$(date +%s)
          ONE_WEEK_AGO=$((CURRENT_TIME - 604800)) # 604800 seconds = 7 days
          
          # List all apps and filter for review apps (not production)
          REVIEW_APPS=$(flyctl apps list --json | jq -r '.[] | select(.Name | startswith("go-sushi-pr-")) | .Name')
          
          if [ -z "$REVIEW_APPS" ]; then
            echo "No review apps found."
            exit 0
          fi
          
          echo "Found review apps to check:"
          echo "$REVIEW_APPS"
          echo ""
          
          for APP_NAME in $REVIEW_APPS; do
            echo "Checking app: $APP_NAME"
            
            # Get app releases to find the first deployment
            RELEASES=$(flyctl releases --app "$APP_NAME" --json 2>&1)
            RELEASES_EXIT_CODE=$?
            
            if [ $RELEASES_EXIT_CODE -ne 0 ]; then
              echo "‚ö†Ô∏è  Error fetching releases for $APP_NAME: $RELEASES"
              echo ""
              continue
            fi
            
            if [ "$RELEASES" = "[]" ] || [ -z "$RELEASES" ]; then
              echo "‚ö†Ô∏è  No releases found for $APP_NAME, skipping..."
              echo ""
              continue
            fi
            
            # Get the oldest release (first deployment) - releases are in reverse chronological order
            OLDEST_RELEASE=$(echo "$RELEASES" | jq -r '.[-1].CreatedAt' 2>/dev/null)
            
            if [ -z "$OLDEST_RELEASE" ] || [ "$OLDEST_RELEASE" = "null" ]; then
              echo "‚ö†Ô∏è  Could not determine creation date for $APP_NAME, skipping..."
              echo ""
              continue
            fi
            
            # Parse the creation timestamp using Python for better reliability
            RELEASE_TIME=$(python3 -c "from datetime import datetime; import sys; dt = datetime.fromisoformat('$OLDEST_RELEASE'.replace('Z', '+00:00')); print(int(dt.timestamp()))" 2>/dev/null || echo "0")
            
            if [ "$RELEASE_TIME" -eq 0 ]; then
              echo "‚ö†Ô∏è  Could not parse date for $APP_NAME, skipping..."
              echo ""
              continue
            fi
            
            AGE_DAYS=$(( (CURRENT_TIME - RELEASE_TIME) / 86400 ))
            
            if [ "$RELEASE_TIME" -lt "$ONE_WEEK_AGO" ]; then
              echo "üìÖ App $APP_NAME is $AGE_DAYS days old (created: $OLDEST_RELEASE)"
              echo "‚öôÔ∏è  Scaling app to 0 machines..."
              
              # Scale the app to 0 and capture error output
              if OUTPUT=$(flyctl scale count 0 --app "$APP_NAME" --yes 2>&1); then
                echo "‚úÖ Successfully scaled $APP_NAME to 0"
              else
                echo "‚ùå Failed to scale $APP_NAME"
                echo "Error output: $OUTPUT"
              fi
            else
              echo "‚úì App $APP_NAME is $AGE_DAYS days old, skipping (less than 7 days)"
            fi
            echo ""
          done
          
          echo "Cleanup complete!"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Summary
        run: |
          echo "Review app cleanup job completed."
          echo "Any review apps older than 1 week have been scaled to 0."
